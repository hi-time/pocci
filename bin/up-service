#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/..; pwd)
source ${BASE_DIR}/bin/lib/init-env

${LIB_DIR}/stop-document-server

SECONDS=0
echo "Start services..."
source ${LIB_DIR}/force-recreate
${LIB_DIR}/docker-compose dns.yml -p ${POCCI_SERVICE_PREFIX} up -d ${FORCE_RECREATE}
${LIB_DIR}/docker-compose docker-compose.yml -p ${POCCI_SERVICE_PREFIX} up -d ${FORCE_RECREATE}
echo "#__ up-service(1): ${SECONDS}"

SECONDS=0
source ${LIB_DIR}/export-env ${CONFIG_DIR}/.env
if [ `docker ps |grep "${JENKINS_CONTAINER}" |wc -l` -gt 0 ]; then
    ${LIB_DIR}/waitfor ${JENKINS_URL}
fi
echo "#__ up-service(2): ${SECONDS}"

SECONDS=0
${BIN_DIR}/up-jenkins-slave
echo "#__ up-service(3): ${SECONDS}"

${LIB_DIR}/create-log-config-file

SECONDS=0
${LIB_DIR}/waitfor ${INTERNAL_SERVICE_URL}
echo "#__ up-service(4): ${SECONDS}"
