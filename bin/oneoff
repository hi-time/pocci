#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/..; pwd)
source ${BASE_DIR}/bin/lib/init-env

if [ -z "${POCCIR_OPTS}" ]; then
    if [ -f "${RUNTIME_DIR}/.env" ]; then
        POCCIR_OPTS="--env-file ${RUNTIME_DIR}/.env"
    fi
    if [ -f "${RUNTIME_DIR}/service-names.env" ]; then
        POCCIR_OPTS="${POCCIR_OPTS} --env-file ${RUNTIME_DIR}/service-names.env"
    fi

    export POCCI_DNS_ADDRESS=`source ${LIB_DIR}/get-dns-address`
    if [ -n "${POCCI_DNS_ADDRESS}" ]; then
        POCCIR_OPTS="${POCCIR_OPTS} --dns ${POCCI_DNS_ADDRESS}"
    fi
fi

if [ -n "${POCCIR_OPTS_ADD}" ]; then
    POCCIR_OPTS="${POCCIR_OPTS} ${POCCIR_OPTS_ADD}"
fi

if [ $# -lt 2 ]; then
    echo "Usage: $0 <container type> <command> [arg...]"
    echo ''
    exit 1
fi

if [ -t 0 ];then
    TTY_OPTION="-it"
else
    TTY_OPTION=" "
fi

CONTAINER_TYPE="$1"
shift
CONTAINER_NAME=poccir_${CONTAINER_TYPE}
CONTAINER_VERSION=$(grep JENKINS_SLAVE_`echo ${CONTAINER_TYPE} |tr '[:lower:]' '[:upper:]'` ${BASE_DIR}/bin/lib/version |cut -d '=' -f 2)

set +e
docker run --name ${CONTAINER_NAME} --privileged -w /app -v ${PWD}:/app ${POCCIR_OPTS} -v /dev/urandom:/dev/random --rm ${TTY_OPTION} xpfriend/jenkins-slave-${CONTAINER_TYPE}:${CONTAINER_VERSION} "$@"
RC=$?

set -e
if [ `docker ps -a |grep ${CONTAINER_NAME} |wc -l` -gt 0 ]; then
    docker rm -v ${CONTAINER_NAME}
fi

exit ${RC}
