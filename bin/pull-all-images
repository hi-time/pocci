#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/..; pwd)
source ${BASE_DIR}/bin/lib/init-env

if [ ! -d ${CONFIG_DIR} ];then
    mkdir ${CONFIG_DIR}
fi

# compose/*.yml
echo "" >${CONFIG_DIR}/all-docker-compose.txt
for i in $(find ${TEMPLATE_DIR}/services/ -name docker-compose.yml.template); do
    source $i >>${CONFIG_DIR}/all-docker-compose.txt
done


# xpfriend/jenkins-slave-*
grep JENKINS_SLAVE ${LIB_DIR}/version |tr '[:upper:]' '[:lower:]' | \
    sed -e 's|version_|  image: xpfriend/|' -e 's/_/-/g' -e 's/=/:/' \
    >> ${CONFIG_DIR}/all-docker-compose.txt

${LIB_DIR}/pull-images all-docker-compose.txt
rm ${CONFIG_DIR}/all-docker-compose.txt


# kanban etc...
for i in $(find ${TEMPLATE_DIR}/services/ -name pull-images.sh); do
    source $i
done
