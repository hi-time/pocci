
replace_no_proxy() {
    if [ -f $1 ]; then
        if [ `grep "no_proxy=pocci," $1 |wc -l` -gt 0 ]; then
            return
        fi
        if [ `grep no_proxy= $1 |wc -l` -gt 0 ]; then
            sed -i "s/no_proxy=.*/no_proxy=${updated_no_proxy}/" $1
        else
            echo "no_proxy=${updated_no_proxy}" >>$1
        fi
    fi
}

if [ -n ${no_proxy} ]; then
    no_proxy_env=${no_proxy}
fi

source ${LIB_DIR}/export-env ${CONFIG_DIR}/.env

default_no_proxy="pocci,127.0.0.1,localhost"

if [ -f ${CONFIG_DIR}/docker-compose.yml ]; then
    for i in $(grep -vh -e '^\s' -e '^\#' -e '^\s*$' ${CONFIG_DIR}/docker-compose.yml | sed -e 's/://'); do
        default_no_proxy="${default_no_proxy},$i"
    done
fi

if [ `ls ${CONFIG_DIR}/nginx/ |wc -l` -gt 0 ]; then
    for i in $(grep -lE "proxy_pass\s+http://" ${CONFIG_DIR}/nginx/*); do
        CONTAINER_NAME=`basename ${i%.conf}`
        default_no_proxy="${default_no_proxy},${CONTAINER_NAME}.${POCCI_DOMAIN_NAME}"
    done
fi

if [ -n "${no_proxy_env}" ]; then
    updated_no_proxy="${default_no_proxy},${no_proxy_env}"
else
    updated_no_proxy="${default_no_proxy}"
fi

replace_no_proxy ${BIN_DIR}/proxy.env
replace_no_proxy ${CONFIG_DIR}/.env
