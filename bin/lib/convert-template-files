
if [ -d ${RUNTIME_DIR}/nginx ]; then
    rm -fr ${RUNTIME_DIR}/nginx
fi

mkdir ${RUNTIME_DIR}/nginx
DEFAULT_SERVICE=""
for i in ${POCCI_SERVICES}; do
    if [ -z ${DEFAULT_SERVICE} ]; then
        DEFAULT_SERVICE=$i
    fi
    cp ${CONFIG_DIR}/services/nginx/$i.conf ${RUNTIME_DIR}/nginx
done
sed -E 's/listen .+80;/listen 80 default_server;/' -i ${RUNTIME_DIR}/nginx/${DEFAULT_SERVICE}.conf

POCCI_PUBLIC_CONTAINERS=""
for i in $(grep -lE "proxy_pass\s+http://" ${RUNTIME_DIR}/nginx/*); do
    if [ "${POCCI_PUBLIC_CONTAINERS}" != "" ]; then
        POCCI_PUBLIC_CONTAINERS="${POCCI_PUBLIC_CONTAINERS}, "
    fi
    PUBLIC_CONTAINER_NAME=`basename ${i%.*}`
    POCCI_PUBLIC_CONTAINERS="${POCCI_PUBLIC_CONTAINERS} ${PUBLIC_CONTAINER_NAME}"
done

source ${CONFIG_DIR}/services/nginx.yml.template >${RUNTIME_DIR}/docker-compose.yml

for i in ${POCCI_SERVICES}; do
    source ${CONFIG_DIR}/services/$i.yml.template >>${RUNTIME_DIR}/docker-compose.yml
done


if [ -d ${RUNTIME_DIR}/volumes ]; then
    rm -fr ${RUNTIME_DIR}/volumes
fi
mkdir ${RUNTIME_DIR}/volumes

for i in ${POCCI_SERVICES}; do
    if [ -d ${CONFIG_DIR}/services/volumes/$i ]; then
        cp -r ${CONFIG_DIR}/services/volumes/$i  ${RUNTIME_DIR}/volumes
    fi
done
