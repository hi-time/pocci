#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/../..; pwd)
source ${BASE_DIR}/bin/lib/init-env

cd ${BASE_DIR}

set +e
DOCKER_HOST_ADDRESS=`ip -o -f inet addr show docker0 | sed -E 's/.*inet ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/'`
if [ -z "${DOCKER_HOST_ADDRESS}" ]; then
    DOCKER_HOST_ADDRESS=172.17.0.1
fi
export DOCKER_HOST_ADDRESS

DOCKER_NETWORK=`docker network inspect bridge |grep Subnet | sed -E 's/.*Subnet": *"(.*)"/\1/'`
if [ -z "${DOCKER_NETWORK}" ]; then
    DOCKER_NETWORK=172.17.0.0/16
fi
export DOCKER_NETWORK


cd ${JS_DIR}
POCCIR_OPTS="-e POCCI_DIR=${BASE_DIR}" ${BIN_DIR}/oneoff ${NODEJS_IMAGE} node -e "require('pocci/yaml2env.js')('config/setup.yml')" >${CONFIG_DIR}/tmp.env
RC=$?

set -e
if [ $RC -ne 0 ]; then
    cat ${CONFIG_DIR}/tmp.env
    rm ${CONFIG_DIR}/tmp.env
    exit ${RC}
fi

cat ${CONFIG_DIR}/tmp.env | tr -d '\r' >${CONFIG_DIR}/.env
rm ${CONFIG_DIR}/tmp.env

echo "DOCKER_HOST_ADDRESS=${DOCKER_HOST_ADDRESS}" >>${CONFIG_DIR}/.env
echo "DNS_ADDRESS=${DOCKER_HOST_ADDRESS}" >>${CONFIG_DIR}/.env
echo "DOCKER_NETWORK=${DOCKER_NETWORK}" >>${CONFIG_DIR}/.env
