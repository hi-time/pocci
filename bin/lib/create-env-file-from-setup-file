#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/../..; pwd)
source ${BASE_DIR}/bin/lib/init-env

cd ${BASE_DIR}

set +e
DOCKER_HOST_ADDRESS=`docker network inspect bridge 2> /dev/null |grep Gateway |sed -E 's/.*".+".*"(.+)"/\1/'`
if [ -z "${DOCKER_HOST_ADDRESS}" ]; then
    DOCKER_HOST_ADDRESS=172.17.42.1
fi
export DOCKER_HOST_ADDRESS

POCCIR_OPTS="-e POCCI_DIR=${BASE_DIR}" ${BIN_DIR}/oneoff ${NODEJS_IMAGE} node -e "require('./bin/js/lib/yaml2env.js')('config/setup.yml')" >${CONFIG_DIR}/tmp.env
RC=$?

set -e
if [ $RC -ne 0 ]; then
    cat ${CONFIG_DIR}/tmp.env
    rm ${CONFIG_DIR}/tmp.env
    exit ${RC}
fi

cat ${CONFIG_DIR}/tmp.env | tr -d '\r' >${CONFIG_DIR}/.env
rm ${CONFIG_DIR}/tmp.env

echo "DOCKER_HOST_ADDRESS=${DOCKER_HOST_ADDRESS}" >>${CONFIG_DIR}/.env
echo "DNS_ADDRESS=${DOCKER_HOST_ADDRESS}" >>${CONFIG_DIR}/.env
