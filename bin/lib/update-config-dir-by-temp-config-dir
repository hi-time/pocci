
source ${LIB_DIR}/export-env ${CONFIG_DIR}/.env

if [ -d ${CONFIG_DIR}/volumes ]; then
    rm -fr ${CONFIG_DIR}/volumes
fi
mkdir ${CONFIG_DIR}/volumes

if [ -d ${CONFIG_DIR}/nginx ]; then
    rm -fr ${CONFIG_DIR}/nginx
fi
mkdir ${CONFIG_DIR}/nginx

for i in $(ls ${TEMP_CONFIG_DIR}/services/backend/scripts/*); do
    source $i
done

DEFAULT_SERVER="default_server"
POCCI_PUBLIC_CONTAINERS=""
for i in ${INTERNAL_SERVICES}; do
    if [ -f ${TEMP_CONFIG_DIR}/services/core/scripts/$i ]; then
        source ${TEMP_CONFIG_DIR}/services/core/scripts/$i
    fi
    if [ -d ${TEMP_CONFIG_DIR}/services/core/volumes/$i ]; then
        cp -r ${TEMP_CONFIG_DIR}/services/core/volumes/$i ${CONFIG_DIR}/volumes
    fi
    if [ -f ${TEMP_CONFIG_DIR}/services/core/nginx/$i.conf.template ]; then
        source ${TEMP_CONFIG_DIR}/services/core/nginx/$i.conf.template >${CONFIG_DIR}/nginx/$i.conf
        DEFAULT_SERVER=""
        if [ "${POCCI_PUBLIC_CONTAINERS}" != "" ]; then
            POCCI_PUBLIC_CONTAINERS="${POCCI_PUBLIC_CONTAINERS},"
        fi
        POCCI_PUBLIC_CONTAINERS="${POCCI_PUBLIC_CONTAINERS} $i"
    fi
done
echo "POCCI_PUBLIC_CONTAINERS=${POCCI_PUBLIC_CONTAINERS}" >>${CONFIG_DIR}/.env


source ${LIB_DIR}/update-dns-entries
${LIB_DIR}/create-proxy-env >>${CONFIG_DIR}/.env
