#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/../..; pwd)
source ${BASE_DIR}/bin/lib/init-env
source ${LIB_DIR}/export-env ${RUNTIME_DIR}/service-names.env

echo "Apply user settings..."
rm -fr ${TEMP_CONFIG_DIR}
mkdir ${TEMP_CONFIG_DIR}
cp -r ${CONFIG_DIR}/* ${TEMP_CONFIG_DIR}
if [ -f ${TEMP_CONFIG_DIR}/jenkins-slaves.yml ]; then
    rm ${TEMP_CONFIG_DIR}/jenkins-slaves.yml
fi

cd ${JS_DIR}
${BIN_DIR}/oneoff iojs node ./app.js

if [ -n "${JENKINS_URL}" ]; then
    if [ -f ${TEMP_CONFIG_DIR}/jenkins-slaves.yml.template ]; then
        cp ${TEMP_CONFIG_DIR}/jenkins-slaves.yml.template ${CONFIG_DIR}
    fi
fi

cp ${TEMP_CONFIG_DIR}/services/*.yml.template ${CONFIG_DIR}/services

${LIB_DIR}/save-config "Update *.yml.template by setup.yml"
