#!/bin/bash
set -e

BASE_DIR=$(cd $(dirname $0)/../..; pwd)
source ${BASE_DIR}/bin/lib/init-env
source ${LIB_DIR}/export-env ${CONFIG_DIR}/.env

SECONDS=0
if [ `docker ps |grep "${JENKINS_CONTAINER}" |wc -l` -gt 0 ]; then
    echo "Update Jenkins plugins..."
    ${LIB_DIR}/docker-exec ${JENKINS_CONTAINER} /config/update-plugins.sh

    PUBLIC_KEY=${CONFIG_DIR}/jenkins.id_rsa.pub
    echo "Get public key --> ${PUBLIC_KEY}"
    docker exec ${JENKINS_CONTAINER} bash -c 'if [ ! -d /var/jenkins_home/.ssh ]; then ssh-keygen -t rsa -N "" -f /var/jenkins_home/.ssh/id_rsa; fi'
    docker exec ${JENKINS_CONTAINER} cat /var/jenkins_home/.ssh/id_rsa.pub >${PUBLIC_KEY}
fi
echo "#__ update-jenkins-container: ${SECONDS}"
